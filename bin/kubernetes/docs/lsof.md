
# Lsof 管理工具

[linux lsof 命令使用指南](https://cizixs.com/2017/05/16/linux-lsof-primer/)

********************************************************************************************************************************************************************************************************

## Lsof 常用命令

### 文件和进程信息

* 列出某个进程打开的所有文件

```bash
sudo lsof -p 1190
```

* 列出某个用户打开的文件

```bash
sudo lsof -u coam
```

* 也可以取反，列出所有不是某个用户打开的文件，只要在用户名之前加上 `^` 符号：

```bash
sudo lsof -u ^coam
```

* 列出某个文件被哪些进程打开（使用）

```bash
sudo lsof /path/to/file
```

* 列出访问某个目录的所有进程

```bash
sudo lsof +d /path/to/dir/
```

* 这个命令并不会递归地去访问子目录，如果想做到这一点，可以使用 +D：

```bash
sudo ls +D /var/log/apache/
```

* 列出某个命令使用的文件信息

```bash
sudo lsof -c nginx
```

> `-c` 参数后面跟着命令的开头字符串，不一定是具体的程序名称，比如 `sudo lsof -c n` 也是合法的，会列出所有名字开头字母是 `n` 的程序打开的文件信息。

这个命令虽然没有 `-p` 查看某个进程更直接，但是对于不能直接查到进程号，或者程序包含多个进程的场景还是有用的。

### 网络信息

`lsof` 另一个比较常用的功能是查看网络信息，虽然有 `netstat` 这个专门的工具，但是 `lsof` 有时候会更方便，比如查看某个端口的使用情况。

* 列出所有的网络连接信息

```bash
sudo lsof -i
```

* 只显示 `TCP` 或者 `UDP` 连接

在 `-i` 后面直接跟着协议的类型（`TCP` 或者 `UDP`）就能只显示该网络协议的连接信息：

```bash
sudo lsof -i TCP
```

* 查看某个端口的网络连接情况

这个命令非常常用，一般要运行服务的时候发现网络冲突，或者需要了解某个端口被哪个进程使用的时候非常方便：

```bash
sudo lsof -i :80
```

* 查看连接到某个主机的网络情况

```bash
sudo lsof -i @172.16.1.14
```

* 端口和主机还可以放在一起使用，表示连接到某个主机特定端口的网络情况：

```bash
sudo lsof -i @172.16.1.14:22
```

* 列出当前机器监听的端口

```bash
sudo lsof -i -s TCP:LISTEN
```

> `-s p:s` 参数跟着两个字段：协议和状态，中间用冒号隔开。比如这里 `TCP:LISTEN` 表示处于监听状态的 `TCP` 协议，类似的，你也可以查看处于已连接的 `TCP` 网络：

```bash
sudo lsof -i -s TCP:ESTABLISHED
```

* 组合用法

`lsof` 的过滤参数是可以组合起来的，但是默认情况下是 `OR` 逻辑，也就是会列出所有过滤条件的总和。可以使用 `-a` 参数告诉 `lsof` 列出同时满足所有条件的结果，比如列出某个进程监听的所有网络连接：

```bash
sudo lsof -a -p 12345 -i -s TCP:LISTEN
```

********************************************************************************************************************************************************************************************************
