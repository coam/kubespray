# kubespray scale

## 扩容新节点后

[Kubeadm fails - kubelet fails to find /etc/kubernetes/bootstrap-kubelet.conf #3769](https://github.com/kubernetes-sigs/kubespray/issues/3769)

启动报错

```bash

```

查看新节点的配置文件:

```bash
$ cat /etc/kubernetes/kubelet.conf
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJME1EVXlNakEwTkRRek4xb1hEVE0wTURVeU1EQTBORFF6TjFvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTTVKCnZ0ZlNWcktGZlJEU1pCVlFvTkpUblljc2lWdDRLaEIrUGl3V0MxaFZuU25IaDFvZktpT3JQUDFlMDRKMzhDbXgKVC84OUx3RVI0WWlVdlFVWDZFTExWZUhQanFZKzBYUnJ2bVk5VE9PWkJwZUVTVGI2eFVJRkRDYzBUNE15R1NvSwpES3JzMTJmNTFxSTVTUzNvU3NDbndrcHZWUWxQbVZwOXQxc0k2eGphT0JsdzJVYklRTUlUdFk4cFdRM2dDSXpRCmIyMjRBQTlzeTg2OFh3MUtBcS8xYVpxYVl4NVZkWTJDczN5VDdqM1YrVjMvaXZzeU1IMXZaTXk3K2xheEZOcXgKcXd1T0o0ZDVoRzF5M2JvTE5yNUxMYi9QQjg1YVRrV3I0MDF0dWZlYmZrdkQyV1Q2ZEhJZzFpUVJYUERBZkNTRQpLYTV0eTZMYVcwRC9oQVJSSjRFQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZJRUJRWU9aZUpESmxzL24wUjNISStyMVhsUGNNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBS1FIaGhBNGlHQzJjMVlGaGJPVQpwUFF4QU14YXBtWk44NlFjZFdaMTNUbjFCQUU2WDQvZE1BOHJ1azVNMTh4TDBLNzRqSWF1aTBndDVhOHRGNnY5Cm11dzV1MW90MGkyYTdjWTBHL1UyTFFVaUZESUFnbllTVldBa25tNVUvS2dXSkdxSFVuUlQ1WU1yUDhrY2RCbW4Ka216UFRNN0JrdUlZSHpMbEFkdURLbDRHODBhajBTUnFoMll5eTBRYStJTmNLK3Q3L0FHWnc0cDYrRVlFdEF2bQpvSzNJckl6enN1VWVnU1ExQ1R5V05tTG5aT2FWNVNSNy9ZeEorbVhNeU1oUllNcjNJb2FuMnN2TEVzbkYrWU5aCnp4eFlYWEtHK2dUNW9Tc29RUHBpVk1VTEsyWlhCVVAxM0FkYnhRQndTMWFOSVZHVDFBUzhOQjFZbkpwT2xSNnkKb2lJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    server: https://localhost:6443
  name: cluster.gpuez
contexts:
- context:
    cluster: cluster.gpuez
    user: system:node:node1
  name: system:node:node1@cluster.gpuez
current-context: system:node:node1@cluster.gpuez
kind: Config
preferences: {}
users:
- name: system:node:node1
  user:
    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem
```

初始化集群节点的配置文件 `/etc/kubernetes/kubelet.conf` 内容如下：

```bash
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJTjRpYlhzYmRJUHN3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBMk1UY3dOek14TlRKYUZ3MHpOVEEyTVRVd056TTJOVEphTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUM0ODVYc0lwTmVnMGphcDhLU2MydEpQRHJzOStiY0l1aE4rVXY0anBZTjJZU0VzcmRVa0w1UExGZ1QKN2VkUDhINmxqVmZUeG9rL3VwUEhZVjlDRHd2eW0xMTFhYUhMOElOdlIwQTJwc2VmOG51ZDU5b2RlVnhBa2VSQgpZbTJValVNdys3bkFRY3VXQnV5Wm9Pem1pMENkNEROS1h6SThxUXk4eTlOM3REem5TRzBnbFl0WnVkeVgwcW9KCkRnQ3o1QUtoZmVPQTBSWEk2dmRKWm0zMXdmNnMzQW9BK0lMZ1A2c3I2R3l0dXM4K3JoS0d5QUZHNFVoUWZEWGoKQzdCcG9DZVd3L1c2U0ZYSEt1RTQ4c3NOL1ZCcjNvME5zc2c2VlFCZFVHN1JsYytza1ZndXRPdVVzazF6Lyt2RQo4NHR5ZnhIUFBPTHBYdEYwb2orMTFQUU1TL2REQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJRbFdPY0tYYmJ3ZUV0SGgvczF2K1Zrekkzcy9EQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ0JUcmZFMTduLwppZVlDQmNVWnpSOWp0SnA0TnRtRHoxQXB1cnFhWTlmRk9xVEJZei92TER1enZjSUo0K0pGNGxMWk54aDQ3Z3Y2CmhFY2hTTGhwVlJrQ05KZCtIcVk1ZTZ1cWVBU2F2VVk1Nm1iVXBoR3dIVkRQd2R2R2hGMnM0S3hPQ0VFdllhKzMKcDYvNG51RmtwdDRqOEpZMEZUSHhMdmVkYVNmWCtKTlVWWCtTZkY5Z2JKL1FrZnp6WnZVbUhNUVNCc2pXOUQ3QwptdEtEZXNNY3oxcHJMem1NSHh2dnVGYmRZT293RjZzNEJ2NGlSZzFJOXdxY1FjRXJRaW1FMEoxTFJxelI1WkV4Ckh6Zk5hQkpuUGFEdzN4NEtFNHIzTDM1SENBeTRpODhuNHM1bHV6NU5EQlpFeGxIM2I2SEtsSDhpQW9ldndVeU4KT2pSWkIxUVI3SFVzCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    server: https://127.0.0.1:6443
  name: default-cluster
contexts:
- context:
    cluster: default-cluster
    namespace: default
    user: default-auth
  name: default-context
current-context: default-context
kind: Config
preferences: {}
users:
- name: default-auth
  user:
    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem
```

发现新节点的 `/etc/kubernetes/kubelet.conf` 配置文件和集群节点的配置文件不一致

于是重新生成并重启 `kubelet`

```bash
$ kubeadm kubeconfig user --org system:nodes --client-name system:node:$(hostname) > kubelet.conf
```

```bash
$ systemctl restart kubelet
$ journalctl -u kubelet -f
dial tcp 10.100.0.108:6443: connect: connection refused
```

最终生成的配置文件 `/etc/kubernetes/kubelet.conf` 如下

```bash
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJME1EVXlNakEwTkRRek4xb1hEVE0wTURVeU1EQTBORFF6TjFvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTTVKCnZ0ZlNWcktGZlJEU1pCVlFvTkpUblljc2lWdDRLaEIrUGl3V0MxaFZuU25IaDFvZktpT3JQUDFlMDRKMzhDbXgKVC84OUx3RVI0WWlVdlFVWDZFTExWZUhQanFZKzBYUnJ2bVk5VE9PWkJwZUVTVGI2eFVJRkRDYzBUNE15R1NvSwpES3JzMTJmNTFxSTVTUzNvU3NDbndrcHZWUWxQbVZwOXQxc0k2eGphT0JsdzJVYklRTUlUdFk4cFdRM2dDSXpRCmIyMjRBQTlzeTg2OFh3MUtBcS8xYVpxYVl4NVZkWTJDczN5VDdqM1YrVjMvaXZzeU1IMXZaTXk3K2xheEZOcXgKcXd1T0o0ZDVoRzF5M2JvTE5yNUxMYi9QQjg1YVRrV3I0MDF0dWZlYmZrdkQyV1Q2ZEhJZzFpUVJYUERBZkNTRQpLYTV0eTZMYVcwRC9oQVJSSjRFQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZJRUJRWU9aZUpESmxzL24wUjNISStyMVhsUGNNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBS1FIaGhBNGlHQzJjMVlGaGJPVQpwUFF4QU14YXBtWk44NlFjZFdaMTNUbjFCQUU2WDQvZE1BOHJ1azVNMTh4TDBLNzRqSWF1aTBndDVhOHRGNnY5Cm11dzV1MW90MGkyYTdjWTBHL1UyTFFVaUZESUFnbllTVldBa25tNVUvS2dXSkdxSFVuUlQ1WU1yUDhrY2RCbW4Ka216UFRNN0JrdUlZSHpMbEFkdURLbDRHODBhajBTUnFoMll5eTBRYStJTmNLK3Q3L0FHWnc0cDYrRVlFdEF2bQpvSzNJckl6enN1VWVnU1ExQ1R5V05tTG5aT2FWNVNSNy9ZeEorbVhNeU1oUllNcjNJb2FuMnN2TEVzbkYrWU5aCnp4eFlYWEtHK2dUNW9Tc29RUHBpVk1VTEsyWlhCVVAxM0FkYnhRQndTMWFOSVZHVDFBUzhOQjFZbkpwT2xSNnkKb2lJPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    server: https://10.100.0.108:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: system:node:server-18
  name: system:node:server-18@kubernetes
current-context: system:node:server-18@kubernetes
kind: Config
preferences: {}
users:
- name: system:node:server-18
  user:
    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURKRENDQWd5Z0F3SUJBZ0lJS1kxc000dTZKd0F3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TkRBMU1qSXdORFEwTXpkYUZ3MHlOakEyTVRjd09EVTRORFZhTURjeApGVEFUQmdOVkJBb1RESE41YzNSbGJUcHViMlJsY3pFZU1Cd0dBMVVFQXhNVmMzbHpkR1Z0T201dlpHVTZjMlZ5CmRtVnlMVEU0TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFtWHBMWUlla2xzYkoKeFF2ek1yYnM0d0ZrQldHK2dVTjN6RkgzUWpxd3lMWXZiNzBWR3NrV0NCQU1FSHdQMEJlRkxUYTdxRStPT3JTZQpWMDNvMjFTeFo4bU9PaUVPY3VYb2NrQlVtemVHc25JY0hwK3JialJLb1dQeStxS0FBOUZFN2ZLa0NKWUQ3OTZDCjI5ZERzOS9qV09ZVFBZc1htTFNQa3R4dUFUcHdHbkhURDJiQ3E2RFNGdGdSb2U3WnBOMXFDREluNXlwaW9IRWcKYldHT25JNGlWemN0MGE0K3JkcW41aXRydEZrdUJBMGdiRWlOeEd0eHh4VW9ZZHJtd29TY2hnT2hwaGxkZFNNNgpIejl1dGpjaCtUUHRJY2dXV3hRZDFwNkVpZGpPekpscWtkMVpzeEx4Yms0bDRYV1pubHRRcFBWRDExeVIrTWgxCkYwUjhtWVFyL1FJREFRQUJvMVl3VkRBT0JnTlZIUThCQWY4RUJBTUNCYUF3RXdZRFZSMGxCQXd3Q2dZSUt3WUIKQlFVSEF3SXdEQVlEVlIwVEFRSC9CQUl3QURBZkJnTlZIU01FR0RBV2dCU0JBVUdEbVhpUXlaYlA1OUVkeHlQcQo5VjVUM0RBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQXViYUdaMzNybm56SXIra25jNWNGR1loVkRQdjhVQ01OCjYxQXlhSnhLdnpNMnhJQ2NNcUMwY05ZYmVaazBLRXFtcFVqSyswOXh5SS9GaEVqejYrTmU4cHpQektqN3AxaGQKdDVtQ2tiZ3p6OWhCTUYxam1UUWl0YUJkYlo4S0pwcnlNekYxSi82djJkd1hKUHZrK0Jya3BUdjdiRkFxVGZDWApvZ2FqUXF5UHJNbStTejhGTG92Y082aDd4aUNGenorUlhvcXZKT1N0Rzc3Y3dOLzU4enBmaDFBVnJoZXRPcjVWCnI4dGNrNFloSFJsekdLdkl0U2pOL3p0WXBVdkRJdDlURFVqV29hb0NwOWxDQ1BqMmhmNTI0MWRDcDJXSERhTXoKRlRLREtDSGpjMGEzRzZwM1hwZ0d4V0ZHdHhKM3pYbjFyT0FPc05kcUdncHUxdVdPaUxjdTNRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBbVhwTFlJZWtsc2JKeFF2ek1yYnM0d0ZrQldHK2dVTjN6RkgzUWpxd3lMWXZiNzBWCkdza1dDQkFNRUh3UDBCZUZMVGE3cUUrT09yU2VWMDNvMjFTeFo4bU9PaUVPY3VYb2NrQlVtemVHc25JY0hwK3IKYmpSS29XUHkrcUtBQTlGRTdmS2tDSllENzk2QzI5ZERzOS9qV09ZVFBZc1htTFNQa3R4dUFUcHdHbkhURDJiQwpxNkRTRnRnUm9lN1pwTjFxQ0RJbjV5cGlvSEVnYldHT25JNGlWemN0MGE0K3JkcW41aXRydEZrdUJBMGdiRWlOCnhHdHh4eFVvWWRybXdvU2NoZ09ocGhsZGRTTTZIejl1dGpjaCtUUHRJY2dXV3hRZDFwNkVpZGpPekpscWtkMVoKc3hMeGJrNGw0WFdabmx0UXBQVkQxMXlSK01oMUYwUjhtWVFyL1FJREFRQUJBb0lCQUJ0Smh3Vk9tSkRHSHpHTgpnbHZOOGlnYUl6Smh3b0V4QWFldUd3d0hhMDhFTlVMa2wwLy8ySTd1YTNheTJBempZYVk4U1BrUHkvWGNEeHJ1Cm15d0R6dGJwR3dSeXhDTGhoWVpxc2FBM0t4ZW0raURudW84SmRRdGt2ZHFaOGJDOEVFbE9EcVFJS0FNSnlMSlYKZjVBSGltQlA1N1BWZXdpSGNjOW1xWmhHVDVBanppbTRpY0hWSjNmdGZMSjFiZDhlZGdERFUyQVFLdjNBZHZNWgpTRDdaczhFRk5SaUtDTk9ENjRxRE1XblorczQzZ1JYQ1d0K2wvUDlOVUR4Tmh2enorVEtwOC9ucmZtOHEzaUJuCkFWYXo1d2MwSXgvaHZDUUZDWkxpWjBDMnF2MU5aQW40M1JUbkpyRjVocmdkTHhRc2hPck1RZ0d0d2xVUkdnQ28KWVlkczVmRUNnWUVBeENXUjArNkk5dGZEVG1OeXg5UWZEVTVJcnU5QlN0VXNOd1k3UEJYTWdVbHh5ZlJQaDI2bAo3QWJJMVVXRytRS1A1VzBvQzZOUGk5RVVGNlFwMHhZS203TkM2R1BTTDNBUW5BbllTVjNCdU4vWGp6N1JpeXQxCm01SUcrWm9vQXJUbmNHTm5uSjRlUGRIVDBkR3lBSFB6ZjhkRkZJb1F0WCtMdUhrQ0hzTnN5RDhDZ1lFQXlFK0sKS0JMTlRkSVdKN0c5THMzc2tEMzRKVkY0NDNaTW9VTHY4QmlDZVFINVNDUy95NW40dXpRNERlM3BaTGlzRmp2MApIVEpuSEd0ZEZvRjBNTFZKbnZQbktHNnJpSHJPVGdvS2tXY2JqcVR2aEkzZjNxS2hkanJXYTFGMkFzRjVoeEgzCllwelE4VXBrTFlpRUU5R25WSjJ2TTAxTkxlREdTdHhBWXBZUFhNTUNnWUE1TVE4dE1WOGtRbE5ETndJUHZBejEKeno2b0swRHBkZkMzZG95cy8xb3ExR1JtVTJNaEJTVkNCZFJuUXllUTBhdHRaUCtKTFN3VGczb05UcU9YVmRUdwpBenZlRU1VSGFmQ2Qzc3orejJTZDZENnRHTTcyZWt5SGVQT3BzY1k2eTg2ejJYZ3JsWHNSNFcyV3YwTGNtUEtGCjdtOTVCcXpLanc4SlVkZEphd2Y3OXdLQmdDMHk1WFhOYUU0YkRheS9TblQ1T2x3QjM3QnNCZDh0bm5UMDZiYy8Ka0pGRmhMNW1ySENBdWNOa01SSFRrVXFNOFNmRE4zNHZGVjB3VEx6N1VRQjhwN1FhVFJxdWZqNDVsN3U4UUU0MgorZHppRXJuU1dhV2ZCTmZzeHQxSWNGeUcwNmxLd0l1YjN2blRVMitDMG1xMmNBK0QxVGk2UktRSmlEVDBKZ01ZCjRUYUpBb0dBUDlkakJrZ0JPOTJaTmRSMTF3TXBYRXBESHlZRm1JVTJQNTlnU09Tdkp1dUVzc0RUbzFXRWpzWjEKTWJDbmpjTUR3ckNtQVV1aDh4V2l4MFVjSTRNVjhpUm1BWTl5Tm9tUC8rNWhEYWJ4cFAwN05YUHZ3dUhUUmtZRQpUZVJaYnZxRXlpa1Z4NExzL3VaMDlXcDV1U1RWUW5HT2JjdTZMcmNhSlRoQXowYTMyVmM9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
```

`kubelet` 服务这下起来了，但是仍然连接不上主节点。